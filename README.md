# Timosh Blanks - MVP система контроля остатков заготовок

MVP система автоматического планирования закупок металлических заготовок для адресников.

## Возможности

- ✅ **Автоматический расчет потребности** в заготовках с учетом брака и сроков поставки
- ✅ **Ежедневные уведомления** о необходимости закупки через Telegram
- ✅ **Простой учет приходов** через Telegram-бот с интуитивным интерфейсом  
- ✅ **Полная прозрачность остатков** в Google Sheets
- ✅ **Webhook интеграция** с KeyCRM для автоматического списания
- ✅ **20 видов заготовок** (кость, бублик, круглые, фигурные формы)

## Архитектура

```
┌─────────────┐    ┌──────────────┐    ┌─────────────────┐
│   KeyCRM    │───▶│   Webhook    │───▶│  Google Sheets  │
│  (заказы)   │    │ (списание)   │    │  (движения)     │
└─────────────┘    └──────────────┘    └─────────────────┘
                            │                    ▲
                            ▼                    │
┌─────────────┐    ┌──────────────┐              │
│ Telegram    │◀───│  Scheduler   │──────────────┘
│ (уведомления)│    │ (расчеты)    │
└─────────────┘    └──────────────┘
       ▲                    
       │            ┌──────────────┐
       └────────────│ Telegram Bot │
                    │ (приходы)    │
                    └──────────────┘
```

## Быстрый старт

### 1. Клонирование проекта

```bash
git clone <repository_url>
cd Warehouse_Automation
```

### 2. Настройка переменных окружения

```bash
cp .env.example .env
# Отредактируйте .env файл с вашими данными
```

### 3. Запуск в режиме разработки

```bash
# Установка зависимостей
make install-dev

# Запуск dev окружения
make dev

# Просмотр логов
make dev-logs
```

### 4. Инициализация Google Sheets

```bash
# После настройки GOOGLE_CREDENTIALS_JSON
python scripts/init_sheets.py
```

## Переменные окружения

| Переменная | Описание | Обязательная |
|------------|----------|--------------|
| `KEYCRM_API_TOKEN` | Токен KeyCRM API | Да |
| `GSHEETS_ID` | ID Google Sheets книги | Да |
| `GOOGLE_CREDENTIALS_JSON` | Service Account credentials | Да |
| `TELEGRAM_BOT_TOKEN` | Токен Telegram бота | Да |
| `TELEGRAM_ALLOWED_USERS` | Список разрешенных user_id | Да |

Полный список см. в [.env.example](.env.example)

## Разработка

### Команды разработки

```bash
make help              # Показать все команды
make install-dev       # Установить dev зависимости  
make test             # Запустить тесты
make lint             # Проверить код
make format           # Отформатировать код
make typecheck        # Проверить типы
```

### Структура проекта

```
src/
├── core/              # Базовые модели и валидация
├── integrations/      # Клиенты внешних API
├── services/          # Бизнес-сервисы
├── webhook/           # FastAPI endpoint
├── bot/              # Telegram бот
├── scheduler/        # Планировщик задач
└── utils/            # Утилиты

tests/                # Тесты
scripts/              # Вспомогательные скрипты
docs/                 # Документация
```

### Тестирование

```bash
# Все тесты
make test

# Тесты с покрытием
make test-coverage

# Конкретные тесты
pytest tests/test_models.py -v
```

## Production деплой

### Docker Compose

```bash
# Сборка и запуск
make build
make up

# Проверка статуса
make status

# Логи
make logs
```

### Сервисы

- **Webhook**: `http://localhost:8000` - прием вебхуков KeyCRM
- **Health Check**: `http://localhost:8000/health`
- **API Docs**: `http://localhost:8000/docs`

## Google Sheets структура

Система создает книгу "Timosh Blanks Planning" со следующими листами:

- **Master_Blanks** - справочник заготовок (20 SKU)
- **Current_Stock** - текущие остатки
- **Movements** - все движения товара  
- **Mapping** - правила маппинга KeyCRM → заготовки
- **Replenishment_Report** - рекомендации по закупкам
- **Config** - системные параметры

## Telegram бот

### Команды

- `/start` - главное меню
- `/receipt` - добавить приход
- `/report` - отчет остатков
- `/help` - справка

### Приход товара

```
Пользователь: ➕ Приход
Бот: Выберите тип заготовки:
     [Кость] [Бублик] [Круглый] [Фигурный]

Пользователь: Фигурный  
Бот: Выберите форму:
     [Сердце] [Цветок] [Облако]

Пользователь: Сердце
Бот: Выберите цвет:
     [🟡 Золото] [⚪ Серебро]

Пользователь: Золото
Бот: Введите количество для BLK-HEART-25-GLD:

Пользователь: 250
Бот: ✅ Добавлен приход:
     BLK-HEART-25-GLD: +250 шт
     Остаток: 420 шт
```

## Webhook интеграция KeyCRM

### Настройка webhook

1. В KeyCRM перейти в настройки webhook
2. URL: `https://your-domain.com/webhook/keycrm`  
3. События: `order.change_order_status`
4. Секретный ключ: значение из `KEYCRM_WEBHOOK_SECRET`

### Обработка заказов

Система автоматически:
1. Получает уведомление о подтвержденном заказе
2. Загружает детали заказа через API
3. Маппит товары на заготовки
4. Создает движения расхода
5. Обновляет остатки в Google Sheets

## Мониторинг и логи

### Health Checks

- `GET /health` - базовая проверка
- `GET /ready` - готовность к работе

### Логи

```bash
# Логи всех сервисов
make logs

# Логи конкретного сервиса
docker-compose logs -f webhook
```

### Структурированные логи

Все логи в JSON формате с полями:
- `timestamp`, `level`, `message`
- `service`, `component`, `user_id`
- `correlation_id` для трассировки

## Безопасность

- ✅ HMAC подпись вебхуков
- ✅ Whitelist Telegram пользователей
- ✅ Валидация всех входных данных
- ✅ Секреты в переменных окружения
- ✅ Непривилегированный пользователь в Docker
- ✅ Rate limiting на endpoint

## Поддержка

При возникновении проблем:

1. Проверьте логи: `make logs`
2. Проверьте health check: `curl http://localhost:8000/health`
3. Проверьте переменные окружения
4. Создайте issue в репозитории

## Лицензия

MIT License - см. [LICENSE](LICENSE)