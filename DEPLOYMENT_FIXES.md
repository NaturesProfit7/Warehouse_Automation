# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ Telegram bot instances
**–§–∞–π–ª:** `main_with_scheduler.py`
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç "terminated by other getUpdates request"
**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_ensure_single_bot_instance()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞
- –£–¥–∞–ª–µ–Ω–∏–µ webhook –∏ —Å–±—Ä–æ—Å pending updates –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ polling —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ `drop_pending_updates=True`
- –£–≤–µ–ª–∏—á–µ–Ω timeout –¥–æ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è stability

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Docker Compose
**–§–∞–π–ª:** `docker-compose.yml`
**–£–ª—É—á—à–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `depends_on: webhook-server` –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞ –∑–∞–ø—É—Å–∫–∞
- –£–≤–µ–ª–∏—á–µ–Ω—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã health check –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:
  - Telegram bot: 60s interval, 60s start_period
  - Webhook server: 60s interval, 30s start_period
- –£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ç—Ä–∞–µ–≤ –¥–æ 5

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤:** ‚úÖ 2/2 –ø—Ä–æ–π–¥–µ–Ω–æ
- –ü–æ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (9000, 9001)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Docker Compose –≤–∞–ª–∏–¥–Ω–∞
- –ö–æ–º–∞–Ω–¥—ã –∑–∞–ø—É—Å–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏:

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –Ω–æ–≤—ã–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
docker-compose down
docker-compose up -d --build

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
docker-compose logs -f telegram-bot
docker-compose logs -f webhook-server
```

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- **telegram-bot**: –ø–æ—Ä—Ç 9001 (health check + Telegram polling)
- **webhook-server**: –ø–æ—Ä—Ç 9000 (KeyCRM webhooks)
- **Nginx proxy**: 443 ‚Üí 9000 –¥–ª—è webhook endpoint
- **Health checks**: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- **Restart policy**: `unless-stopped` –¥–ª—è –∞–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã, —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.