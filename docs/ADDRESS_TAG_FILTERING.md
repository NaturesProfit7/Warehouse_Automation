# Фильтрация товаров по адресникам

## Обзор

Система автоматически обрабатывает только **адресники**, игнорируя все остальные товары (шнурки, игрушки, талисманы, пакеты и т.д.). Это позволяет точно контролировать остатки заготовок без необходимости создавать маппинги для каждого товара в каталоге.

## Принцип работы

### 1. Идентификация адресников

Товар считается адресником, если в его названии содержится одно из ключевых слов:
- **"адресник"** - основное ключевое слово
- **"жетон"** - альтернативное название  
- **"медальон"** - дополнительное название

```python
# Примеры товаров, которые будут обработаны:
✅ "Адресник бублик"
✅ "Адресник фігурний" 
✅ "жетон круглий"
✅ "медальон для собак"

# Примеры товаров, которые будут пропущены:
❌ "Шнурок червоний"
❌ "Талісман дружби"
❌ "Іграшка банан"
❌ "Пакети рулон"
```

### 2. Маппинг свойств

Система поддерживает различные типы адресников с автоматическим извлечением свойств:

#### Круглые адресники
- **Размер:** `"Розмір": "20 мм"` / `"25 мм"` / `"30 мм"`
- **Цвет:** `"Колір": "золото"` / `"срібло"`

#### Бублики (кольца)
- **Размер:** `"Розмір": "25 мм"` / `"30 мм"`  
- **Цвет:** `"Колір": "золото"` / `"срібло"`

#### Кости
- **Размер:** `"Розмір": "маленька"` / `"велика"`
- **Цвет:** `"Колір": "золото"` / `"срібло"`

#### Фигурные адресники
- **Форма:** `"Форма": "серце"` / `"квітка"` / `"хмарка"`
- **Цвет:** `"Колір": "золото"` / `"срібло"`

> **Важно:** Для фигурных адресников система проверяет как поле `"Розмір"`, так и `"Форма"`, поскольку KeyCRM может отправлять форму в любом из этих полей.

## Процесс обработки заказа

### 1. Получение webhook от KeyCRM
```json
{
  "event": "order.change_order_status", 
  "context": {
    "id": 4522,
    "status_id": 1,
    "products": [...]
  }
}
```

### 2. Фильтрация товаров
```python
for item in order.items:
    if not self._is_address_tag_product(item):
        skipped_items.append(item)
        logger.info("Item skipped - not an address tag", product_name=item.product_name)
        continue
    # Обработка адресника...
```

### 3. Поиск маппинга
```python
# Извлечение свойств с поддержкой "Форма" для фигурных
size_property = (item.properties.get("Розмір", "") or 
                item.properties.get("Форма", "")).strip()
metal_color = item.properties.get("Колір", "").strip()
```

### 4. Создание движения
Если маппинг найден:
- Создается движение расхода заготовки
- Обновляется остаток в Google Sheets  
- Записывается в лист "Movements"

Если маппинг не найден:
- Товар записывается в лист "Unmapped_Items" для дальнейшей доработки

## Статистика обработки

В логах отображается подробная статистика:

```json
{
  "order_id": 4522,
  "movements_created": 3,     // Адресники с найденными маппингами
  "unmapped_items": 0,        // Адресники без маппингов  
  "skipped_items": 0,         // Не-адресники (пропущено)
  "total_items": 3            // Общее количество товаров
}
```

## Примеры обработки

### Заказ только с адресниками
```
Заказ #4521: 2 товара
• Адресник фігурний (квітка, золото) → BLK-FLOWER-25-GLD ✅
• Адресник фігурний (хмарка, срібло) → BLK-CLOUD-25-SIL ✅

Результат: 2 движения, 0 пропущено, 0 unmapped
```

### Смешанный заказ  
```
Заказ #4519: 3 товара
• Іграшка банан → пропущено ❌
• Талісман дружби → пропущено ❌  
• Адресник бублик (золото, 25мм) → BLK-RING-25-GLD ✅

Результат: 1 движение, 2 пропущено, 0 unmapped
```

### Заказ с unmapped адресником
```
Заказ #4518: 1 товар
• Адресник фігурний (новая форма) → нет маппинга ⚠️

Результат: 0 движений, 0 пропущено, 1 unmapped
```

## Конфигурация

### Добавление нового типа адресника

1. **Добавить маппинг в Google Sheets** (лист "Mapping"):
```
product_name: "Адресник новый"
size_property: "большой" 
metal_color: "золото"
blank_sku: "BLK-NEW-30-GLD"
qty_per_unit: 1
active: TRUE
priority: 50
```

2. **При необходимости расширить ключевые слова**:
```python
address_tag_keywords = [
    "адресник",
    "жетон", 
    "медальон",
    "новое_слово"  # Добавить здесь
]
```

### Добавление нового свойства

Если KeyCRM начнет отправлять размер в новом поле, добавить в код:
```python
size_property = (item.properties.get("Розмір", "") or 
                item.properties.get("Форма", "") or
                item.properties.get("НовеПоле", "")).strip()
```

## Мониторинг и отладка

### Логирование
- **DEBUG:** Детали распознавания адресников
- **INFO:** Статистика обработки, пропущенные товары
- **WARNING:** Адресники без маппингов
- **ERROR:** Ошибки обработки

### Google Sheets мониторинг
- **Movements:** Все созданные движения
- **Unmapped_Items:** Адресники требующие доработки маппингов
- **Current_Stock:** Актуальные остатки заготовок

### Защита от дублирования
Система использует hash-based проверку для предотвращения дублирующих движений при повторных webhooks от KeyCRM.

## Производительность

- **Фильтрация на уровне товаров** - минимизирует обращения к Google Sheets
- **Кеширование маппингов** - 5 минут, снижает API вызовы
- **Batch операции** - все движения добавляются одним запросом

## Безопасность

- Проверка подлинности webhooks через User-Agent
- Валидация всех входных данных
- Логирование всех операций для аудита
- Graceful обработка ошибок без потери данных